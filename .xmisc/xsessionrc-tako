keymap() {
    # Microsoft Wireless All-In-One Media Keyboard (N9Z-00001) 専用設定
    # キーボード左上の [マウス左ボタン対応キー] と [タッチパッドの右下]
    # を同時に押すことによりマウスの 3 ボタン目をエミュレーションできる
    for id in $(xinput list | sed -n -e 's/.*Microsoft.*id=\([0-9][0-9]*\).*pointer.*/\1/p'); do
        if xinput list-props $id | egrep -q -w -i 'middle emulation'; then
            xinput set-prop $id 'libinput Middle Emulation Enabled' 1
        fi
    done

    if xmodmap -pp | awk '$1 ~ /^[0-9]+$/ && \
                          $2 ~ /^[0-9]+$/ && \
                          $1 != $2 { exit 1 }'; then
        xmodmap $HOME/.xmisc/xmodmap.N9Z
    fi
}

displayconfig() {
    # どこかで誰かが LVDS1 を primary に設定してしまう
    xrandr --output VGA1 --primary
}

screenblank() {
    xset s on
    xset s 1800 0
    xset s noblank
    xset dpms 0 0 0
    xset -dpms
}

if [ -t 0 ]; then
    # 端末から読み込まれた場合
    keymap
    displayconfig
    screenblank
else
    # ~/.xsessionrc から読み込まれた場合
    (sleep 5; keymap) > /dev/null 2>&1 &
    (sleep 10; displayconfig; screenblank) > /dev/null 2>&1 &
fi

unset -f keymap
unset -f displayconfig
unset -f screenblank
